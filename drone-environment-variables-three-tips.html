<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="Laszlo Fogas, a self employed DevOps consultant going into products">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta content="Drone Environment Variables - Three tips" property="og:title">
  <meta content="website" property="og:type">
  <meta content="https://laszlo.cloud/images/1500x500.jpg" property="og:image">
  <meta content="https://laszlo.cloud/laszlo.jpg" property="og:image">
  <meta content="https://laszlo.cloud/drone-environment-variables-three-tips" property="og:url">
  <meta content="Laszlo Fogas" property="og:site_name">
  <meta content="These are tricks I gathered over the years using Drone.io environment variables. All testable with `drone exec`." property="og:description">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@laszlocph">
  <meta name="twitter:creator" content="@laszlocph">
  <meta name="twitter:title" content="Drone Environment Variables - Three tips">
  <meta name="twitter:description" content="These are tricks I gathered over the years using Drone.io environment variables. All testable with `drone exec`.">
  <meta name="twitter:image" content="https://laszlo.cloud/images/1500x500.jpg">

  <title>Drone Environment Variables - Three tips - Laszlo Fogas</title>
  <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/main.css?2">
  <meta name="google-site-verification" content="rRfVaMDPujw_KMAWJY0A3P6wZ3uP8pg2_-Bp0nAbLqg" />

</head>
<body style="position: relative">
  <div class="container mx-auto p-4">
    <div class="flex">
      <div class="hidden md:block md:w-3/12"></div>
      <div class="w-full md:w-6/12 max-w-xl">
        <h1><a href="./">Laszlo Fogas</a></h1>
        <img src="images/1500x500.jpg"/>
      </div>
      <div class="hidden md:block md:w-3/12"></div>
    </div>
    <div class="flex">
      <div class="hidden md:block md:w-3/12"></div>
      <div class="w-full md:w-6/12 max-w-xl">
        <h2 id="drone-environment-variables---three-tips">Drone Environment Variables - Three tips</h2>

<p>2019-03-26</p>

<p>These are tricks I gathered over the years using Drone.io environment variables.</p>

<ul>
  <li>generating a practical Docker image tag</li>
  <li>fixing an annoying issue with env vars</li>
  <li>the sweetness of yaml anchors</li>
</ul>

<p>All testable with <code class="highlighter-rouge">drone exec</code>.</p>

<h3 id="using-built-in-vars-to-generate-a-practical-docker-image-tag">Using built-in vars to generate a practical Docker image tag</h3>

<p>Drone has a set of built in variables that you can use to name your artifacts. You can find most Git and Drone related metadata on the supported list of vars <a href="https://docs.drone.io/reference/environ/" target="\_blank">here</a>.</p>

<p>Drone also provides Bash parameter substitution like features to further manipulate the environment variables.</p>

<p>Hence my favorite Docker image tag is generated like this:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">${DRONE_BRANCH//\//-}-${DRONE_COMMIT_SHA:0:8}</span>
</code></pre></div></div>

<p>First I replace forward slashes with a dash and only take the first 8 characters of the commit hash. You can use this <code class="highlighter-rouge">.drone.yml</code> and run it with <code class="highlighter-rouge">drone exec</code>.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">kind</span><span class="pi">:</span> <span class="s">pipeline</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">default</span>

<span class="na">steps</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">docker-tag-demo</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">debian:stable-slim</span>
    <span class="na">commands</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">echo "The current branch is ${DRONE_BRANCH}"</span>
      <span class="pi">-</span> <span class="s">echo "The current commit hash is ${DRONE_COMMIT_SHA}"</span>
      <span class="pi">-</span> <span class="s">echo "The image tag is ${DRONE_BRANCH//\//-}-${DRONE_COMMIT_SHA:0:8}"</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DRONE_COMMIT_SHA=3c1c9db713758d57a254eed96b0457cc9af3ae6b \
./drone exec \
  --branch feature/new-feature
[docker-tag-demo:1] The current branch is feature/new-feature
[docker-tag-demo:3] The current commit hash is 3c1c9db713758d57a254eed96b0457cc9af3ae6b
[docker-tag-demo:5] The image tag is feature-new-feature-3c1c9db7
</code></pre></div></div>

<h3 id="when-variables-resolve-to-empty-string">When variables resolve to empty string</h3>

<p>There is a gotcha with environment variables that is best presented with the following pipeline.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">kind</span><span class="pi">:</span> <span class="s">pipeline</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">default</span>

<span class="na">steps</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">docker-tag-demo</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">debian:stable-slim</span>
    <span class="na">commands</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">echo "The value is ${MY_VAR}"</span>
      <span class="pi">-</span> <span class="s">echo "It was empty, but not this one $MY_VAR</span>
      <span class="pi">-</span> <span class="s">echo "Nor this one $${MY_VAR}"</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"MY_VAR=dummyvalue"</span> <span class="o">&gt;</span> varfile
drone <span class="nb">exec</span> <span class="nt">--env-file</span><span class="o">=</span>varfile
<span class="o">[</span>docker-tag-demo:1] The value is 
<span class="o">[</span>docker-tag-demo:3] It was empty, but not this one dummyvalue
<span class="o">[</span>docker-tag-demo:5] Nor this one dummyvalue
</code></pre></div></div>

<p>This is an annoying one to fix. Due to the demonstrated substitution functions, the <code class="highlighter-rouge">${variable}</code> expressions are subject to pre-processing. If you do not want the pre-processor to evaluate your expression, it must be escaped with an extra dollar sign: <code class="highlighter-rouge">$${variable}</code>.</p>

<h3 id="reusing-common-variable-groups-with-yaml-anchors">Reusing common variable groups with Yaml anchors</h3>

<p>It happens that I needed to set the same environment variables in several of my Drone pipeline steps.</p>

<p>This quickly grows the yaml file so that it difficult to work with it. But then I figured out the syntax of yaml anchors.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">global-variables</span><span class="pi">:</span>
  <span class="na">debian_image</span><span class="pi">:</span> <span class="nl">&amp;debian_image</span> <span class="s">debian:7.11-slim</span>
  <span class="na">environment</span><span class="pi">:</span> <span class="nl">&amp;default_environment</span>
    <span class="na">HOST</span><span class="pi">:</span> <span class="s">postgres</span>
    <span class="na">USER</span><span class="pi">:</span> <span class="s">postgres</span>

<span class="na">kind</span><span class="pi">:</span> <span class="s">pipeline</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">default</span>

<span class="na">steps</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">anchor test</span>
    <span class="na">image</span><span class="pi">:</span> <span class="nv">*debian_image</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="s">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*default_environment</span>
    <span class="na">commands</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">echo "The host is $${HOST}"</span>
      <span class="pi">-</span> <span class="s">echo "The user is $${USER}"</span>
</code></pre></div></div>

<h3 id="thanks-for-reading">Thanks for reading</h3>

<p>Onwards!</p>

        <hr />
        <div class="font-sans text-sm text-gray-600">
          <p>Are you running Kubernetes?</p>
          You can bootstrap logging, metrics and ingress with my new project, Gimlet Stack. Head over to <a href="https://gimlet.io/concepts/gimlet-stack-concepts/">gimlet.io</a> and see if it helps you.
        </div>
      </div>
      <div class="hidden md:block md:w-3/12 p-6 pl-8 font-sans text-sm text-gray-600">
        <div class="sticky top-0 pt-4">
  <p class="uppercase"><strong>On this page</strong></p>
  <ul id="toc" class="list-none w-48 pl-0">
  <li class="mb-3"><a href="#using-built-in-vars-to-generate-a-practical-docker-image-tag" class="font-sans text-sm text-gray-600">Using built-in vars to generate a practical Docker image tag</a></li>
  <li class="mb-3"><a href="#when-variables-resolve-to-empty-string" class="font-sans text-sm text-gray-600">When variables resolve to empty string</a></li>
  <li class="mb-3"><a href="#reusing-common-variable-groups-with-yaml-anchors" class="font-sans text-sm text-gray-600">Reusing common variable groups with Yaml anchors</a></li>
  <li class="mb-3"><a href="#thanks-for-reading" class="font-sans text-sm text-gray-600">Thanks for reading</a></li>
</ul>

  <button class="bg-transparent hover:bg-blue-500 text-blue-700 font-semibold hover:text-white py-2 px-4 border border-blue-500 hover:border-transparent rounded" onclick="document.body.scrollTop=0;document.documentElement.scrollTop=0;">
      Back to top
  </button>
</div>
      </div>
    </div>
  </div>
<!-- Fathom - beautiful, simple website analytics -->
<script src="https://rat.gimlet.io/script.js" site="SWFGFITA" defer></script>
<!-- / Fathom -->

<script type="text/javascript" src="/assets/javascripts/homepage.js" async></script>
</body>
</html>
