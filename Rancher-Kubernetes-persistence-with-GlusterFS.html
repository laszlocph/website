<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="Hi I'm Laszlo Fogas, Devops consultant. My mission is elevating team cultures through automation and tooling. As a former engineering director I gained the perspective to effectively operate on many levels of your organization. I feel home in developer advocacy, building CI/CD pipelines and Cloud infrastructure, up to stakeholder management.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta content="Rancher Kubernetes persistence with GlusterFS" property="og:title">
  <meta content="website" property="og:type">
  <meta content="/rancher.png" property="og:image">
  <meta content="/laszlo.jpg" property="og:image">
  <meta content="/Rancher-Kubernetes-persistence-with-GlusterFS" property="og:url">
  <meta content="Laszlo Fogas" property="og:site_name">
  <meta content="How do you handle persistence when you orchestrate Docker containers? The question I'm constantly being asked when starting a new project." property="og:description">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@laszlocph">
  <meta name="twitter:creator" content="@laszlocph">
  <meta name="twitter:title" content="Rancher Kubernetes persistence with GlusterFS">
  <meta name="twitter:description" content="How do you handle persistence when you orchestrate Docker containers? The question I'm constantly being asked when starting a new project.">
  <meta name="twitter:image" content="/rancher.png">

  <title>Rancher Kubernetes persistence with GlusterFS - Laszlo Fogas</title>
  <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/main.css?2">
  <meta name="google-site-verification" content="rRfVaMDPujw_KMAWJY0A3P6wZ3uP8pg2_-Bp0nAbLqg" />

</head>
<body style="position: relative">
  <div class="container mx-auto max-w-6xl p-4">
    <div class="flex">
      <div class="hidden md:block md:w-3/12"></div>
      <div class="w-full md:w-6/12 max-w-xl">
        <h1><a href="./">Laszlo Fogas</a></h1>
        <img src="images/1500x500.jpg"/>
      </div>
      <div class="hidden md:block md:w-3/12"></div>
    </div>
    <div class="flex">
      <div class="hidden md:block md:w-3/12"></div>
      <div class="w-full md:w-6/12 max-w-xl">
        <h2 id="rancher-kubernetes-persistence-with-glusterfs">Rancher Kubernetes persistence with GlusterFS</h2>
<p>2017-05-26</p>

<p>The bellow described method was tested on the Rancher Kubernetes distribution but I borrow the code from a previous project when I used Openshift. It works on both platforms without any modification.</p>

<p>Not surprisingly as the Kubernetes upstream generally <a href="https://kubernetes.io/docs/concepts/storage/volumes/#types-of-volumes">supports</a> GlusterFS. This definitelly raise my confidence level and lowers the risk when you pick a Kube distro. The yaml files are mostly portable, like in an occasion when I flipped my five service large project from Openshift to Google Cloude Engine (GKE) in six hours.</p>

<p>But back to the main question, the infamous one:</p>

<p>How do you handle persistence when you orchestrate Docker containers?</p>

<p>The question I’m constantly being asked when starting a new project.</p>

<p>And my answer is: you don’t. Or at least I hope you won’t. But instead, your services are stateless, and when it comes to state you use Cloud Native solutions like S3 for files and a managed RDS instance for your data.</p>

<p>Persistence is a hard question, and the answers the Docker world gives you are no different than the current solutions out there. At the end of the day you either make sure that the same folder structure is available on all your cluster nodes (with NFS for example outside of Kubernetes) or talk to the file cluster on a given endpoint through a proprietary protocol like in the case with GlusterFS.</p>

<p>But let’s say you do a lift and shift project, or the managed cloud services are not an option for you, what do you do then?</p>

<p>Just allow me one more thought here and I promise I won’t be the grumpy dev anymore: make sure you containerize your persistence / database for the right reasons. In my experience databases are not the workloads that mostly benefit from the many advantages Docker gives you. You are not releasing new version of your database every day - hack every six month would be uncommon.</p>

<p>I guess all I’m saying is start with the usecases that most benefit from containers: with your stateless services. Think twice before you containerize your database, leave it til the very end once you gained operational expertise with your new cluster, or perhaps leave it out completely. Or do it only on your QA environments, which by the way the most brilliant usecase for containerized databases in my opinion. I could kill for test environments per pull request backed by its dedicated database serving anonimized production exports. I’m sure your QA would kill for it too.</p>

<h3 id="install-glusterfs">Install GlusterFS</h3>

<p>In my experience the tutorials around Gluster often start with installing Gluster as a <em>containerized</em> service. Well that was rather confusing to me, perhaps because of the quality of the tutorials I’ve read, but the moment I installed Gluster on dedicated nodes, everything fell into its place.</p>

<p>Kubernetes only acted as a client for GlusterFS and I only had to navigate the logical concepts of Kubernetes for accessing the storage.</p>

<p>Installing a standalone Gluster cluster (hah!) was proven to be very easy following the <a href="https://gluster.readthedocs.io/en/latest/Quick-Start-Guide/Quickstart/">Gluster quickstart</a>. It’s as easy as the length of the page suggests. Sweet.</p>

<h3 id="the-chain-of-abstractions">The chain of abstractions</h3>

<p>There are quite a few entities you have to create to be able to store a file from your Kube service.</p>

<p>Bare in mind that they all bring a level of abstraction - thus flexibility - but it’s a bit overwhelming at first, and if you miss a piece, your chain will be broken and it won’t work.</p>

<ul>
  <li>a volume on your GlusterFS cluster (cluster admin’s responsibility)</li>
  <li>a persistent volume in Kubernetes (cluster admin’s responsibility)</li>
  <li>a persistent volume claim (developer’s responsibility)</li>
  <li>a volume mount in your yaml (developer’s responsibility)</li>
</ul>

<p>You have to create all the above entities for any given volume, and on top of that, as a one time setup, you have to create</p>

<ul>
  <li>a Kubernetes endpoint for the GlusterFS cluster (cluster admin’s responsibility)</li>
  <li>a Kubernetes service for the endpoint (cluster admin’s responsibility)</li>
</ul>

<p>In brackets I listed who is responsible for each component.</p>

<p>The Persistent Volume (PV) - Persistent Volume Claim (PVC) construct detach the management of the storage from the usage. The developers don’t have to know the underlyng implementation. Well, besides the access characteristics.</p>

<h3 id="the-yamls">The yamls</h3>

<p>First create the endpoint and the service to describe the access details of the standalone GlusterFS.</p>

<h4 id="40-gluster-endpointyml">40-gluster-endpoint.yml</h4>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Endpoints</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">glusterfs-cluster</span>
<span class="na">subsets</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">addresses</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">ip</span><span class="pi">:</span> <span class="s">10.0.1.102</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="s">1</span>
  <span class="pi">-</span> <span class="na">addresses</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">ip</span><span class="pi">:</span> <span class="s">10.0.1.103</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="s">1</span>
</code></pre></div></div>

<h4 id="40-gluster-serviceyml">40-gluster-service.yml</h4>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">glusterfs-cluster</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="s">1</span>
</code></pre></div></div>

<h4 id="50-persistent-volumeyml">50-persistent-volume.yml</h4>

<p>Then reference the endpoint to tell Kubernetes where the GlusterFS cluster is available, and the “gv0” volume name in that you created in GlusterFS.</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PersistentVolume</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">fileupload-vol</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">dev</span><span class="pi">:</span> <span class="s">dev</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">accessModes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ReadWriteMany</span>
  <span class="na">capacity</span><span class="pi">:</span>
    <span class="na">storage</span><span class="pi">:</span> <span class="s">500M</span>
  <span class="na">glusterfs</span><span class="pi">:</span>
    <span class="na">endpoints</span><span class="pi">:</span> <span class="s">glusterfs-cluster</span>
    <span class="na">path</span><span class="pi">:</span> <span class="s">gv0</span>
  <span class="na">persistentVolumeReclaimPolicy</span><span class="pi">:</span> <span class="s">Recycle</span>
</code></pre></div></div>

<h4 id="60-pvcyml">60-pvc.yml</h4>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PersistentVolumeClaim</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">file-upload-claim</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">accessModes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ReadWriteMany</span>
  <span class="na">resources</span><span class="pi">:</span>
     <span class="na">requests</span><span class="pi">:</span>
       <span class="na">storage</span><span class="pi">:</span> <span class="s">100M</span>
</code></pre></div></div>

<h4 id="60-nginx-svcyml">60-nginx-svc.yml</h4>

<p>Finally deploy your service, and mount the previously defined persistent volume.</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">List</span>
<span class="na">items</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">extensions/v1beta1</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
  <span class="na">metadata</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">spec</span><span class="pi">:</span>
    <span class="na">replicas</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">template</span><span class="pi">:</span>
      <span class="na">metadata</span><span class="pi">:</span>
        <span class="na">labels</span><span class="pi">:</span>
          <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
      <span class="na">spec</span><span class="pi">:</span>
        <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
          <span class="na">volumeMounts</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/mnt/</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">dir-1</span>   
        <span class="na">volumes</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">dir-1</span>
            <span class="na">persistentVolumeClaim</span><span class="pi">:</span>
              <span class="na">claimName</span><span class="pi">:</span> <span class="s">file-upload-claim</span>
</code></pre></div></div>

<blockquote class="instagram-media" data-instgrm-captioned="" data-instgrm-version="7" style=" background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:658px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);"><div style="padding:8px;"> <div style=" background:#F8F8F8; line-height:0; margin-top:40px; padding:50.0% 0; text-align:center; width:100%;"> <div style=" background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAMUExURczMzPf399fX1+bm5mzY9AMAAADiSURBVDjLvZXbEsMgCES5/P8/t9FuRVCRmU73JWlzosgSIIZURCjo/ad+EQJJB4Hv8BFt+IDpQoCx1wjOSBFhh2XssxEIYn3ulI/6MNReE07UIWJEv8UEOWDS88LY97kqyTliJKKtuYBbruAyVh5wOHiXmpi5we58Ek028czwyuQdLKPG1Bkb4NnM+VeAnfHqn1k4+GPT6uGQcvu2h2OVuIf/gWUFyy8OWEpdyZSa3aVCqpVoVvzZZ2VTnn2wU8qzVjDDetO90GSy9mVLqtgYSy231MxrY6I2gGqjrTY0L8fxCxfCBbhWrsYYAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;"></div></div> <p style=" margin:8px 0 0 0; padding:0 4px;"> <a href="https://www.instagram.com/p/BU1z0EShN-V/" style=" color:#000; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none; word-wrap:break-word;" target="_blank">#kubernetes #k8s VolumeMounts and watching changes on the GlusterFS node&#39;s filesystem</a></p> <p style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;">A post shared by Laszlo Cloud (@laszlo.cloud) on <time style=" font-family:Arial,sans-serif; font-size:14px; line-height:17px;" datetime="2017-06-02T14:36:38+00:00">Jun 2, 2017 at 7:36am PDT</time></p></div></blockquote>
<script async="" defer="" src="//platform.instagram.com/en_US/embeds.js"></script>

<h3 id="caveats">Caveats</h3>

<p>If you deployed all the components, you should be able to create a file within your pod and validate the creation on your GlusterFS volume.</p>

<p>There are two issues I faced in my deployment. The recycle <em>persistentVolumeReclaimPolicy</em> is not yet implemented, so I had to create a cleanup cron task, and second, the volume was mounted for the root user and I couldn’t find a nice solution to grant access to my non root user in the container. I used a <em>postStart</em> lifecycle action in the pod definition, but I wasn’t very satisfied with this solution.</p>

<p>UPDATE: just realized that fsGroup as described <a href="https://kubernetes.io/docs/concepts/policy/security-context/">here</a> is solving the problem with the ownership of folders on the mounted disk.</p>

      </div>
      <div class="hidden md:block md:w-3/12 p-6 pl-8 font-sans text-sm text-gray-600">
        <div class="sticky top-0 pt-4">
  <p class="uppercase"><strong>On this page</strong></p>
  <ul id="toc" class="list-none w-48 pl-0">
  <li class="mb-3"><a href="#install-glusterfs" class="font-sans text-sm text-gray-600">Install GlusterFS</a></li>
  <li class="mb-3"><a href="#the-chain-of-abstractions" class="font-sans text-sm text-gray-600">The chain of abstractions</a></li>
  <li class="mb-3"><a href="#the-yamls" class="font-sans text-sm text-gray-600">The yamls</a>
    <ul>
      <li class="mb-3"><a href="#40-gluster-endpointyml" class="font-sans text-sm text-gray-600">40-gluster-endpoint.yml</a></li>
      <li class="mb-3"><a href="#40-gluster-serviceyml" class="font-sans text-sm text-gray-600">40-gluster-service.yml</a></li>
      <li class="mb-3"><a href="#50-persistent-volumeyml" class="font-sans text-sm text-gray-600">50-persistent-volume.yml</a></li>
      <li class="mb-3"><a href="#60-pvcyml" class="font-sans text-sm text-gray-600">60-pvc.yml</a></li>
      <li class="mb-3"><a href="#60-nginx-svcyml" class="font-sans text-sm text-gray-600">60-nginx-svc.yml</a></li>
    </ul>
  </li>
  <li class="mb-3"><a href="#caveats" class="font-sans text-sm text-gray-600">Caveats</a></li>
</ul>

  <button class="bg-transparent hover:bg-blue-500 text-blue-700 font-semibold hover:text-white py-2 px-4 border border-blue-500 hover:border-transparent rounded" onclick="document.body.scrollTop=0;document.documentElement.scrollTop=0;">
      Back to top
  </button>
</div>
      </div>
    </div>
  </div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-84825803-1', 'auto');
  ga('send', 'pageview');

</script>

<script type="text/javascript" src="/assets/javascripts/homepage.js" async></script>
</body>
</html>
