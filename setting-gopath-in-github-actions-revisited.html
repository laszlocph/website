<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="Laszlo Fogas, a self employed DevOps consultant going into products">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta content="Setting GOPATH in Github Actions - revisited" property="og:title">
  <meta content="website" property="og:type">
  <meta content="https://laszlo.cloud/images/1500x500.jpg" property="og:image">
  <meta content="https://laszlo.cloud/laszlo.jpg" property="og:image">
  <meta content="https://laszlo.cloud/setting-gopath-in-github-actions-revisited" property="og:url">
  <meta content="Laszlo Fogas" property="og:site_name">
  <meta content="Github Actions defaults are not ideal for Golang projects. This article shows how I configured GOPATH in Actions." property="og:description">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@laszlocph">
  <meta name="twitter:creator" content="@laszlocph">
  <meta name="twitter:title" content="Setting GOPATH in Github Actions - revisited">
  <meta name="twitter:description" content="Github Actions defaults are not ideal for Golang projects. This article shows how I configured GOPATH in Actions.">
  <meta name="twitter:image" content="https://laszlo.cloud/images/1500x500.jpg">

  <title>Setting GOPATH in Github Actions - revisited - Laszlo Fogas</title>
  <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/main.css?2">
  <meta name="google-site-verification" content="rRfVaMDPujw_KMAWJY0A3P6wZ3uP8pg2_-Bp0nAbLqg" />

</head>
<body style="position: relative">
  <div class="container mx-auto p-4">
    <div class="flex">
      <div class="hidden md:block md:w-3/12"></div>
      <div class="w-full md:w-6/12 max-w-xl">
        <h1><a href="./">Laszlo Fogas</a></h1>
        <img src="images/1500x500.jpg"/>
      </div>
      <div class="hidden md:block md:w-3/12"></div>
    </div>
    <div class="flex">
      <div class="hidden md:block md:w-3/12"></div>
      <div class="w-full md:w-6/12 max-w-xl">
        <h2 id="setting-gopath-in-github-actions---revisited">Setting GOPATH in Github Actions - revisited</h2>

<p>2019-08-29</p>

<p>If you are yet to adopt Go modules, you ought to have GOPATH set in Github Actions to have your builds succeed.</p>

<p>I <a href="https://laszlo.cloud/setting-gopath-in-github-actions" target="\_blank">already found</a> a way how to set $GOPATH and in this article I demonstrate a slightly different approach.</p>

<p>But first a detour to understand the environment.</p>

<h3 id="actions-runner-environment">Actions runner environment</h3>

<p>With the <code class="highlighter-rouge">runs-on: ubuntu-latest</code> field you can set the runtime environment for the job. This will define the host VM the job will run in.</p>

<p>Github Actions provide a few ways to override the execution environment - or technically to start Docker containers inside this VM and perform steps in these Docker containers.</p>

<h4 id="the-run-step">The run step</h4>

<p>The most simple way to perform custom steps in Actions is to use the <code class="highlighter-rouge">run</code> field. This will run shell commands in the host VM’s shell.</p>

<p>So this is not really an override of the execution environment, but more like the simplest way to use the default.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s">Go</span>
<span class="na">on</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">push</span><span class="pi">]</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">my-first-job</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">My first job</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Hello</span>
      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">echo "Hello world"</span>
        <span class="s">echo "Yaml allows me to have multiline commands"</span>
</code></pre></div></div>

<p>See the <a href="https://help.github.com/en/articles/workflow-syntax-for-github-actions#jobsjob_idstepsrun" target="\_blank">reference</a>.</p>

<h4 id="using-a-custom-action">Using a custom action</h4>

<p>Github Actions - the product - is about the reusable building blocks, called <em>actions</em>.</p>

<p>Actions are Docker containers made to perform one specific task. They accept incoming parameters in the <code class="highlighter-rouge">with</code> field, but don’t allow customized behavior, eg a <code class="highlighter-rouge">run</code> field can’t be used to override behavior.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Check out code</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v1</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">fetch-depth</span><span class="pi">:</span> <span class="m">1</span>
</code></pre></div></div>

<p>Under the hood the runner pulls the actions Docker image and runs it on the host VM.</p>

<p>This is a way to run Docker containers, but with predefined behavior. You can write your own actions too, <a href="https://help.github.com/en/articles/building-actions" target="\_blank">check out how</a>.</p>

<h4 id="the-docker-runner-environment">The docker runner environment</h4>

<p>There is a third way to define the exection environment. By using the <code class="highlighter-rouge">container</code> field, you can run custom commands within a specific Docker container.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s">Go</span>
<span class="na">on</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">push</span><span class="pi">]</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Build</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">container</span><span class="pi">:</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">golang:1.12.4</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Debug</span>
      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">go version</span>
</code></pre></div></div>

<p>The above example sets the execution environment to be the <code class="highlighter-rouge">golang:1.12.4</code> container, and all steps will be performed in that image, thus the Go tooling will be available throughout the job.</p>

<p>The <code class="highlighter-rouge">runs-on</code> field is still mandatory as there is always a host machine, but with this approach I can prebake images that have the needed tools installed. Like <code class="highlighter-rouge">kubectl</code> or <code class="highlighter-rouge">go</code>.</p>

<p>This also differs from the canonical examples on the Github Actions page where the <code class="highlighter-rouge">actions/setup-go@v1</code> action is used to install Go - the approach I also used in the first part of this article.</p>

<h3 id="setting-gopath-using-the-docker-execution-environment">Setting GOPATH using the docker execution environment</h3>

<p>Putting the above in practice, and using the checkout path trick from the <a href="https://laszlo.cloud/setting-gopath-in-github-actions" target="\_blank">first part</a> of this article, here is how I compiled go with Github Actions.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s">Go</span>
<span class="na">on</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">push</span><span class="pi">]</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Build</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">container</span><span class="pi">:</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">golang:1.12.4</span>
      <span class="na">env</span><span class="pi">:</span>
        <span class="na">GOPATH</span><span class="pi">:</span> <span class="s">/__w/woodpecker/go/</span>
    <span class="na">steps</span><span class="pi">:</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Check out code into the Go module directory</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v1</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">fetch-depth</span><span class="pi">:</span> <span class="m">1</span>
        <span class="na">path</span><span class="pi">:</span> <span class="s">go/src/github.com/laszlocph/woodpecker</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Test</span>
      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">go get -u golang.org/x/tools/cmd/cover</span>
        <span class="s">go get -u golang.org/x/net/context</span>
        <span class="s">go get -u golang.org/x/net/context/ctxhttp</span>
        <span class="s">go get -u github.com/golang/protobuf/proto</span>
        <span class="s">go get -u github.com/golang/protobuf/protoc-gen-go</span>
        <span class="s">go test -cover $(go list ./... | grep -v /vendor/)</span>
</code></pre></div></div>

<h3 id="i-was-keen-on-using-the-containerized-environment-for-couple-of-reasons">I was keen on using the containerized environment for couple of reasons</h3>

<p>First, <code class="highlighter-rouge">actions/setup-go@v1</code> is not ready yet, and setting $GOPATH manually is cumbersome.</p>

<p>Second, I’m a big supporter of the Drone.io CI system which to this day has revolutionary architecture. In Drone each step of the pipeline is performed in a specific Docker image. Replicating that behavior with Actions was my desire and I could achieve some of it.</p>

<p>The <code class="highlighter-rouge">jobs.container</code> field does an okay job setting the runtime environment, but it also differs from Drone as there is only one image to be used in the whole job.</p>

<p>I’m not sure what to think of the Github Actions containerized environment and  Github doesn’t seem to be sure either. There are multiple ways to control the runtime as I listed in this article, and the Github tutorials seem to favor the host machine examples, not the container ones.</p>

<p>One thing is clear though, Actions is flexible and the best practices will solidify over time.</p>

<p>Oh and one more thing, did you know that you can run <code class="highlighter-rouge">docker-compose up</code> in Actions? <a href="https://github.com/peter-evans/docker-compose-actions-workflow" target="\_blank">Proof</a>.</p>

<p>Onwards!</p>

        <hr />
        <div class="font-sans text-sm text-gray-600">
          <p>Are you running Kubernetes?</p>
          You can bootstrap logging, metrics and ingress with my new project, Gimlet Stack. Head over to <a href="https://gimlet.io/concepts/gimlet-stack-concepts/">gimlet.io</a> and see if it helps you.
        </div>
      </div>
      <div class="hidden md:block md:w-3/12 p-6 pl-8 font-sans text-sm text-gray-600">
        <div class="sticky top-0 pt-4">
  <p class="uppercase"><strong>On this page</strong></p>
  <ul id="toc" class="list-none w-48 pl-0">
  <li class="mb-3"><a href="#actions-runner-environment" class="font-sans text-sm text-gray-600">Actions runner environment</a>
    <ul>
      <li class="mb-3"><a href="#the-run-step" class="font-sans text-sm text-gray-600">The run step</a></li>
      <li class="mb-3"><a href="#using-a-custom-action" class="font-sans text-sm text-gray-600">Using a custom action</a></li>
      <li class="mb-3"><a href="#the-docker-runner-environment" class="font-sans text-sm text-gray-600">The docker runner environment</a></li>
    </ul>
  </li>
  <li class="mb-3"><a href="#setting-gopath-using-the-docker-execution-environment" class="font-sans text-sm text-gray-600">Setting GOPATH using the docker execution environment</a></li>
  <li class="mb-3"><a href="#i-was-keen-on-using-the-containerized-environment-for-couple-of-reasons" class="font-sans text-sm text-gray-600">I was keen on using the containerized environment for couple of reasons</a></li>
</ul>

  <button class="bg-transparent hover:bg-blue-500 text-blue-700 font-semibold hover:text-white py-2 px-4 border border-blue-500 hover:border-transparent rounded" onclick="document.body.scrollTop=0;document.documentElement.scrollTop=0;">
      Back to top
  </button>
</div>
      </div>
    </div>
  </div>
<!-- Fathom - beautiful, simple website analytics -->
<script src="https://rat.gimlet.io/script.js" site="SWFGFITA" defer></script>
<!-- / Fathom -->

<script type="text/javascript" src="/assets/javascripts/homepage.js" async></script>
</body>
</html>
